---
title: "Spatial analysis of ship strike risk for Rice’s whale in the Gulf of Mexico"
author: "Benjamin D. Best, Ph.D. (<ben@ecoquants.com>)"
date: now
date-format: "YYYY-MM-DD HH:mm (z)"
bibliography: "ricei.bib"
format:
  html:
    toc: true
    number-sections: true
    number-depth: 3
    code-fold: true
    code-tools: true
  docx:
    toc: true
    toc-depth: 3
    toc-title: "Contents"
    number-sections: true
    code-annotations: false
    execute:
      echo: false
      warning: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = F,
  warning = F,
  message = F)

source(here::here("scripts/functions.R"))
source(here("scripts/paths.R"))

ply_study  <- read_sf(study_geo)
ply_cells  <- read_sf(cells_geo)
ply_units  <- read_sf(units_gpkg)
ply_ships  <- read_sf(ships_geo)
ply_whales <- read_sf(whales_geo)
ply_bia    <- read_sf(bia_geo)
ply_wab    <- read_sf(wab_geo)
ply_wan    <- read_sf(wan_geo)
tbl_ships  <- read_csv(ships_csv)
tbl_whales <- read_csv(whales_csv)
lns_depth_contours <- read_sf(depth_contours_geo)
stk_rast   <- rast(rast_tif)
r_cells    <- stk_rast["cell_id"]
tbl_units <- ply_units |> 
  st_drop_geometry()
```

## Abstract

Since release of the Biological Opinion on oil and gas activities in the Gulf of Mexico [@nmfsBiologicalOpinionFederally2020] that used a published density surface model [@robertsHabitatbasedCetaceanDensity2016] to describe the distribution of the critically endangered Rice's whale (_Balaenoptera ricei_), a new density surface model [@litzCetaceanSeaTurtle2022] has been made available. Importantly, this model extends the distribution of Rice's whale beyond its initial core habitat in the Eastern Gulf of Mexico to the West, where it had previously only been acoustically detected [@soldevillaRiceWhalesNorthwestern2022]. This report replicates the Biological Opinion's ship strike analysis using the newer Rice's whale distributional model. Given the wider distribution of Rice's whale, an alternative new Whale Area is suggested to reduce ship strike risk with the Rice's whale based on location (25.5º N and higher) and depth (100 to 400 m).

## Whale Densities

The new density surface model [@litzCetaceanSeaTurtle2022] uses approximately 40 km^2^ hexagons as its spatial unit to describe number of individuals per 40 km^2^ in a Lambert Conformal Conic projection, whereas the original model [@robertsHabitatbasedCetaceanDensity2016] used 100 km^2^ cells in a custom equal area Albers projection to describe number of individuals per 100 km^2^. The spatial unit for this new analysis is also 100 km^2^ cells but in the web Mercator projection (EPSG: 3857) in order to readily map results online with common "slippy" basemaps. All layers were clipped to the study area of the U.S. Exclusive Economic Zone (EEZ) within the Gulf of Mexico.

Normally converting polygons to raster extracts only the centroid point of the raster cell from the underlying polygon. In order to capture the entirety of the underlying geometric densities, a vector-based intersection was first performed on all layers (whale hexagons, ship cells, and new units) before summarizing to the raster cell as area-weighted means.

In order to adjust for slight differences from projecting coordinate reference systems and rounding errors, the new 100 km^2^ whale density grid was adjusted so the sum of individuals predicted throughout the study area is equal to `r n_whales_Garrison2020`, the most recent abundance estimate [@garrisonAbundanceMarineMammals2020] from the same 2017 and 2018 surveys as the new density model [@litzCetaceanSeaTurtle2022] was derived. 


<!-- - discuss changing distribution -->

Compared to the original distribution (@fig-map-whales-old), the whales are now concentrated along the strip from 100 to 400 m extending into the Western Gulf of Mexico (@fig-map-whales-new).

```{r}
#| label: fig-map-whales-old
#| fig-cap: "Map of previous whale densities [@robertsHabitatbasedCetaceanDensity2016]  as 100 km^2^ cells used by [@nmfsBiologicalOpinionFederally2020] showing the dominance in the northeastern corner of the Gulf of Mexico. The recommended Whale Area [p. 292 of @nmfsBiologicalOpinionFederally2020] is depicted by the pink outline polygon for vessel slowdown and nighttime avoidance. Depth contours are shown in dash blacked lines for 100 m (finer) and 400 m (thicker)."

map_rast(
  r = rast(whales_roberts2016_img), 
  legend_title = "Whales<br><small>(Roberts, 2016)<br>(# / 100 km<sup>2</sup>)</small>",
  group = "whales_per_100km2_Roberts2016",
  add_depth_contours =T,
  add_ply_wab = T)
```

The original Whale Area is described [p. 292 of @nmfsBiologicalOpinionFederally2020] as:

> This opinion defines the Bryde’s whale area to include the area from 100- to 400- meter isobaths from 87.5° W to 27.5° N as described in the status review (Rosel 2016) plus an additional 10 km around that area.

```{r}
#| label: fig-map-whales-new
#| fig-cap: "Map of new whale densities [@litzCetaceanSeaTurtle2022] as 100 km^2^ cells showing a distribution throughout the region. The newly recommended Whale Area is depicted by the red outline polygon for vessel slowdown and nighttime avoidance using similar logic as to [@nmfsBiologicalOpinionFederally2020]. Depth contours are shown in dash blacked lines for 100 m (finer) and 400 m (thicker)."

map_rast(
  r = stk_rast["whales_avg_n_per_100km2"], 
  legend_title = "Whales<br><small>(Litz, 2022)<br>(# / 100 km<sup>2</sup>)</small>",
  group = "whales_per_100km2_Litz2022",
  add_depth_contours=T,
  add_ply_wan = T)
```


```{r}
#| label: tbl-whales-by-area
#| tbl-cap: Table of new whale densities [@litzCetaceanSeaTurtle2022] summarized by total study area (U.S. Gulf of Mexico), previous Whale Area [@nmfsBiologicalOpinionFederally2020] and newly proposed Whale Area.

d <- read_csv(whales_n_by_area_csv) |> 
  mutate(
    n_whales_gom   = round(n_whales_gom, 1),
    n_whales_wab   = round(n_whales_wab, 1),
    pct_whales_wab = percent(pct_whales_wab, accuracy=1),
    n_whales_wan   = round(n_whales_wan, 1),
    pct_whales_wan = percent(pct_whales_wan, accuracy=1))
  
# names(d) |> paste(collapse= '",\n"" = "') |> cat()
col_names <- c(
  "# Whales in Study (U.S. Gulf of Mexico)" = "n_whales_gom",
  "# Whales in Original Mitigation Area (NMFS, 2020)" = "n_whales_wab",
  "% Whales in Original Mitigation Area (NMFS, 2020)" = "pct_whales_wab",
  "# Whales in New Mitigation Area" = "n_whales_wan",
  "% Whales in New Mitigation Area" = "pct_whales_wan")

d |> 
  rename(all_of(col_names)) |> 
  kable()
```

## Vessel Traffic


```{r}
#| label: fig-ships-avg-all-gt01
#| fig-cap: "Map of annual average traffic (km) for all vessel types at all speeds from AIS data (2014 to 2018)."

map_rast(stk_rast["ships_avg_all_gt01"], "Traffic,<br><small>all types,<br>all speeds,<br>avg year<br>(km)</small>", "RdYlGn")
```

```{r}
#| label: fig-ships-avg-boem-gt01
#| fig-cap: "Map of annual average traffic (km) for oil and gas vessels at all speeds from AIS data (2014 to 2018)."

map_rast(stk_rast["ships_avg_boem_gt01"], "Traffic,<br><small>oil & gas,<br>all speeds,<br>avg year<br>(km)</small>", "RdYlGn")
```

```{r}
#| label: fig-ships-avg-all-gt10
#| fig-cap: "Map of annual average traffic (km) for all vessel types > 10 knots from AIS data (2014 to 2018)."

map_rast(stk_rast["ships_avg_all_gt01"], "Traffic,<br><small>all types,<br>> 10 knots,<br>avg year<br>(km)</small>", "RdYlGn")
```

```{r}
#| label: fig-ships-avg-boem-gt10
#| fig-cap: "Map of annual average traffic (km) for oil and gas vessels > 10 knots from AIS data (2014 to 2018)."

map_rast(stk_rast["ships_avg_boem_gt01"], "Traffic,<br><small>oil & gas,<br>> 10 knots,<br>avg year<br>(km)</small>", "RdYlGn")
```


## Vessel Risk to Whales


```{r}
#| label: fig-risk-avg-all-gt01
#| fig-cap: "Map of risk (# whales * km vessel traffic) for all vessels at all speeds."

stk_rast["risk_avg_all_gt01"] |> 
  map_rast("Risk,<br><small>all types,<br>all speeds<br>(# * km)</small>", "RdYlGn")
```


```{r}
#| label: fig-risk-avg-boem-gt10
#| fig-cap: "Map of risk (# whales * km vessel traffic) for oil and gas vessels > 10 knots."

stk_rast["risk_avg_boem_gt10"] |> 
  map_rast("Risk,<br><small>oil & gas,<br>> 10 knots <br>(# * km)</small>", "RdYlGn")
```

The overall vessel strike risk to Rice's whale is presented in @tbl-risk-overview \[similar to Table 49 [@nmfsBiologicalOpinionFederally2020]\].

```{r}
#| label: tbl-risk-overview
#| tbl-cap: "Vessel strike risk (# whales * km vessel traffic) to Rice's whales for oil and gas vessels compared with all vessels."

d <- read_csv(risk_overview_csv) |> 
  mutate(
    risk_all_gt01  = round(risk_all_gt01)  |> format(big.mark = ","),
    risk_boem_gt01 = round(risk_boem_gt01) |> format(big.mark = ","),
    pct_boem_gt01  = percent(pct_boem_gt01, accuracy=1),
    risk_all_gt10  = round(risk_all_gt10)  |> format(big.mark = ","),
    risk_boem_gt10 = round(risk_boem_gt10) |> format(big.mark = ","),
    pct_boem_gt10  = percent(pct_boem_gt10, accuracy=1))
# names(d) |> paste(collapse= '",\n"" = "') |> cat()
col_names <- c(
  "Year" = "yr",
  "Vessel Strike Risk for All Vessel Traffic All Speeds" = "risk_all_gt01",
  "Vessel Strike Risk for Oil and Gas Vessel Traffic All Speeds" = "risk_boem_gt01",
  "Proportion of Vessel Strike Risk due to Oil and Gas Vessel Traffic All Speeds" = "pct_boem_gt01",
  "Vessel Strike Risk for All Vessel Traffic > 10 knots" = "risk_all_gt10",
  "Vessel Strike Risk for Oil and Gas Vessel Traffic > 10 knots" = "risk_boem_gt10",
  "Proportion of Vessel Strike Risk due to Oil and Gas Vessel Traffic > 10 knots" = "pct_boem_gt10")

d |> 
  rename(all_of(col_names)) |> 
  kable()
```


```{r}
#| label: tbl-risk-gt10-reduction-by-areas
#| tbl-cap: "Reduction of vessel strike risk over 10 knots (# whales * km vessel traffic) to Rice's whales with enforcement of proposed mitigation areas for oil and gas vessels."

d <- read_csv(risk_gt10_reduction_by_areas_csv) |> 
  # names() |> paste(collapse=", ")
  select(yr, risk_boem_gt10_wab, pct_risk_reduced_boem_gt10_wab, risk_boem_gt10_wan, pct_risk_reduced_boem_gt10_wan) |> 
  mutate(
    # risk_all_gt10  = round(risk_all_gt10)  |> format(big.mark = ","),
    # risk_boem_gt10 = round(risk_boem_gt10) |> format(big.mark = ","),
    # pct_boem_gt10  = percent(pct_boem_gt10, accuracy=1),
    risk_boem_gt10_wab             = round(risk_boem_gt10_wab)  |> format(big.mark = ","),
    pct_risk_reduced_boem_gt10_wab = percent(pct_risk_reduced_boem_gt10_wab, accuracy=1),
    risk_boem_gt10_wan             = round(risk_boem_gt10_wan) |> format(big.mark = ","),
    pct_risk_reduced_boem_gt10_wan = percent(pct_risk_reduced_boem_gt10_wan, accuracy=1))
# names(d) |> paste(collapse= '",\n"" = "') |> cat()
col_names <- c(
  "Year" = "yr",
  # "Vessel Strike Risk for All Vessel Traffic > 10 knots" = "risk_all_gt10",
  # "Vessel Strike Risk for Oil and Gas Vessel Traffic > 10 knots" = "risk_boem_gt10",
  # "Proportion of Vessel Strike Risk due to Oil and Gas Vessel Traffic All Speeds" = "pct_boem_gt10",
  "Vessel Strike Risk for Oil and Gas Vessel Traffic > 10 knots within the Original Whale Area (NMFS, 2020; Figure 1)" = "risk_boem_gt10_wab",
  "Proportion of Risk Reduction to All Vessel Traffic through Enforcement on Oil & Gas Vessels of the Original Whale Area (NMFS, 2020; Figure 1)" = "pct_risk_reduced_boem_gt10_wab",
  "Vessel Strike Risk for Oil and Gas Vessel Traffic > 10 knots within the New Whale Area (NMFS, 2020; Figure 2)" = "risk_boem_gt10_wan",
  "Proportion of Risk Reduction to All Vessel Traffic through Enforcement on Oil & Gas Vessels of the New Whale Area (Figure 2)" = "pct_risk_reduced_boem_gt10_wan")

d |> 
  rename(all_of(col_names)) |> 
  kable()
```


```{r}
#| label: tbl-risk-gt01-reduction-by-areas
#| tbl-cap: "Reduction of vessel strike risk at all speeds (# whales * km vessel traffic) to Rice's whales with enforcement of proposed mitigation areas for oil and gas vessels."

d <- read_csv(risk_gt01_reduction_by_areas_csv) |> 
  # names() |> paste(collapse=", ")
  select(yr, risk_boem_gt01_wab, pct_risk_reduced_boem_gt01_wab, risk_boem_gt01_wan, pct_risk_reduced_boem_gt01_wan) |> 
  mutate(
    # risk_all_gt01  = round(risk_all_gt01)  |> format(big.mark = ","),
    # risk_boem_gt01 = round(risk_boem_gt01) |> format(big.mark = ","),
    # pct_boem_gt01  = percent(pct_boem_gt01, accuracy=1),
    risk_boem_gt01_wab             = round(risk_boem_gt01_wab)  |> format(big.mark = ","),
    pct_risk_reduced_boem_gt01_wab = percent(pct_risk_reduced_boem_gt01_wab, accuracy=1),
    risk_boem_gt01_wan             = round(risk_boem_gt01_wan) |> format(big.mark = ","),
    pct_risk_reduced_boem_gt01_wan = percent(pct_risk_reduced_boem_gt01_wan, accuracy=1))
# names(d) |> paste(collapse= '",\n"" = "') |> cat()
col_names <- c(
  "Year" = "yr",
  # "Vessel Strike Risk for All Vessel Traffic > 10 knots" = "risk_all_gt01",
  # "Vessel Strike Risk for Oil and Gas Vessel Traffic > 10 knots" = "risk_boem_gt01",
  # "Proportion of Vessel Strike Risk due to Oil and Gas Vessel Traffic All Speeds" = "pct_boem_gt01",
  "Vessel Strike Risk for Oil and Gas Vessel Traffic at all speeds within the Original Whale Area (NMFS, 2020; Figure 1)" = "risk_boem_gt01_wab",
  "Proportion of Risk Reduction to All Vessel Traffic through Enforcement on Oil & Gas Vessels of the Original Whale Area (NMFS, 2020; Figure 1)" = "pct_risk_reduced_boem_gt01_wab",
  "Vessel Strike Risk for Oil and Gas Vessel Traffic at all speeds within the New Whale Area (Figure 2)" = "risk_boem_gt01_wan",
  "Proportion of Risk Reduction to All Vessel Traffic through Enforcement on Oil & Gas Vessels of the New Whale Area (NMFS, 2020; Figure 2)" = "pct_risk_reduced_boem_gt01_wan")

d |> 
  rename(all_of(col_names)) |> 
  kable()
```



## References {.unnumbered}





